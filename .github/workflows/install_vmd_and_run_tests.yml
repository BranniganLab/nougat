name: VMD installation and nougat testing

on:
  push:
    branches:
      - '**'

jobs:
  build-vmd:
    runs-on: ubuntu-latest
    env:
        VMDINSTALLBINDIR: "${{ github.workspace }}/.cache/vmd-install/bin"
        VMDINSTALLLIBRARYDIR: "${{ github.workspace }}/.cache/vmd-install/lib"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libx11-dev \
            libglu1-mesa-dev \
            libxi-dev \
            libxext-dev \
            libxmu-dev \
            libjpeg-dev \
            libpng-dev \
            tcl-dev \
            tk-dev \
            python3-dev \
            flex \
            bison \
            git

      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy scipy matplotlib
          pip install pytest
          pip install ./python/

      # Step 1: Generate GitHub App token
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: BranniganLab
          repositories: |
            vmd_for_testing

      # Step 2: Get tarball SHA for cache key
      - name: Get tarball SHA
        id: commit-sha
        run: |
          SHA=$(curl -s -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
              https://api.github.com/repos/BranniganLab/vmd_for_testing/contents/vmd-1.9.4a57.bin.LINUXAMD64-CUDA102-OptiX650-OSPRay185.opengl.tar.gz \
              | jq -r '.sha')
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      # Step 3: Cache the installed VMD
      - name: Cache VMD installation
        id: cache-install
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/.cache/vmd-install
          key: vmd-install-${{ steps.commit-sha.outputs.sha }}-${{ runner.os }}

      # Step 4: Download tarball if cache miss
      - name: Download VMD tarball
        if: steps.cache-install.outputs.cache-hit != 'true'
        run: |
          mkdir -p .github/vmd_src
          curl -L -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o .github/vmd_src/vmd.tar.gz \
               https://api.github.com/repos/BranniganLab/vmd_for_testing/contents/vmd-1.9.4a57.bin.LINUXAMD64-CUDA102-OptiX650-OSPRay185.opengl.tar.gz

      # Step 5: Build and install VMD if cache miss
      - name: Build and install VMD
        if: steps.cache-install.outputs.cache-hit != 'true'
        run: |
          echo "No cache hit â€” compiling VMD..."
          mkdir -p $GITHUB_WORKSPACE/.cache/vmd-install
          tar xzf ./.github/vmd_src/vmd.tar.gz
          cd vmd-1.9.4a57
          ./configure
          cd src
          make install

      # Step 6: Add VMD to PATH
      - name: Add VMD to PATH
        run: |
          echo "$GITHUB_WORKSPACE/.cache/vmd-install/bin" >> $GITHUB_PATH

      # Step 7: Verify installation
      - name: Verify VMD installation
        run: |
          echo "Testing VMD installation..."
          vmd -dispdev text -e /dev/null
          if [ $? -ne 0 ]; then
            echo "VMD failed to run!"
            exit 1
          else
            echo "VMD installation verified successfully."
          fi

      # Step 8: Run nougat.tcl unit tests
      - name: Run nougat.tcl unit tests
        run: |
          cd $GITHUB_WORKSPACE/testing_materials/
          echo "Starting nougat.tcl unit testing"
          vmd -dispdev none -eofexit < ./tcltest/unit_test.test -args . 2>&1 | tee ./tcl_unit_test.log
          if [ ! -s ./tcl_unit_test.log ]
          then
            echo "Something went wrong. Testing never ran."
            exit 1
          fi
          if grep -E 'invalid \command|bad \option|nt \load \file|unknown \option' ./tcl_unit_test.log
          then
            echo "Errors occurred when attempting to perform the test."
            echo "Review tcl_unit_test.log for details."
            exit 1
          fi
          if grep FAILED ./tcl_unit_test.log
          then
            echo "One or more tests failed."
            echo "Review tcl_unit_test.log for details."
            exit 1
          fi

      # Step 9: Run nougat.py unit tests
      - name: Run nougat.py unit tests
        run: |
          echo "Starting nougat.py unit testing"
          python -m pytest ./tcltest/Unit_Test.py

      # Step 10: Generate new values for regression testing
      - name: Generate new values for regression testing
        run: |
          echo "Running nougat.tcl on test systems in preparation for regression testing."
          vmd -dispdev none -e ./run_nougat_test.tcl 2>&1 | tee ./nougat_test_outputs.log
          if grep -q -e "can't" -e "couldn't" ./nougat_test_outputs.log
          then
            echo "An error occurred when running nougat.tcl on the test systems"
            exit 1
          fi

      # Step 11: Regression testing
      - name: Regression testing
        run: |
          echo "Regression testing start"
          python3 -m pytest ./tests/